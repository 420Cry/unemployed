name: Godot Build (No Export)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        platform: [Windows, Mac]

    runs-on: ${{ matrix.platform == 'Mac' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Godot
        run: |
          set -eux
          VERSION="4.5-stable"
          WORKDIR="$RUNNER_TEMP/godot"
          mkdir -p "$WORKDIR"

          download() {
            url="$1"
            out="$2"
            for i in {1..3}; do
              echo "Trying: $url (attempt $i)"
              curl -fsSL "$url" -o "$out" && return 0
              sleep 5
            done
            return 1
          }

          if [ "${{ matrix.platform }}" = "Mac" ]; then
            candidates=(
              "Godot_v${VERSION}_macos_universal.zip"
              "Godot_v${VERSION}_macos.zip"
              "Godot_v${VERSION}_macos.universal.zip"
            )
          else
            candidates=(
              "Godot_v${VERSION}_linux.x86_64.zip"
              "Godot_v${VERSION}_linux.x86_64.tar.xz"
            )
          fi

          EDITOR_ARCHIVE=""
          for name in "${candidates[@]}"; do
            url="https://github.com/godotengine/godot/releases/download/${VERSION}/${name}"
            out="$WORKDIR/$name"
            if download "$url" "$out"; then
              EDITOR_ARCHIVE="$out"
              break
            fi
          done

          # Extract editor
          case "$EDITOR_ARCHIVE" in
            *.zip) unzip -q "$EDITOR_ARCHIVE" -d "$WORKDIR" ;;
            *.tar.xz) tar -xJf "$EDITOR_ARCHIVE" -C "$WORKDIR" ;;
          esac

          # Locate Godot binary
          if [ "${{ matrix.platform }}" = "Mac" ]; then
            GODOT_BIN=$(find "$WORKDIR" -type f -path "*/Godot.app/Contents/MacOS/Godot" -print -quit)
          else
            GODOT_BIN=$(find "$WORKDIR" -type f -executable -name "Godot_v${VERSION}_linux.x86_64" -print -quit)
          fi

          chmod +x "$GODOT_BIN"
          echo "GODOT_BIN=$GODOT_BIN" >> $GITHUB_ENV

      - name: Verify project build (headless)
        run: |
          set -eux
          # Run Godot headless to scan and register scripts/plugins
          "$GODOT_BIN" --headless --quit --verbose
