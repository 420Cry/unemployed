name: Godot Cross-Platform Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      matrix:
        platform: [Windows, Mac]

    runs-on: ${{ matrix.platform == 'Mac' && 'macos-latest' || matrix.platform == 'Windows' && 'windows-latest' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Godot
        run: |
          set -eux
          VERSION="4.5-stable"
          WORKDIR="$RUNNER_TEMP/godot"
          mkdir -p "$WORKDIR"

          download() {
            url="$1"
            out="$2"
            for i in {1..3}; do
              echo "Trying: $url (attempt $i)"
              curl -fsSL "$url" -o "$out" && return 0
              sleep 5
            done
            return 1
          }

          if [ "${{ matrix.platform }}" = "Mac" ]; then
            candidates=(
              "Godot_v${VERSION}_macos_universal.zip"
              "Godot_v${VERSION}_macos.zip"
              "Godot_v${VERSION}_macos.universal.zip"
            )
          else
            candidates=(
              "Godot_v${VERSION}_linux.x86_64.zip"
              "Godot_v${VERSION}_linux.x86_64.tar.xz"
            )
          fi

          EDITOR_ARCHIVE=""
          for name in "${candidates[@]}"; do
            url="https://github.com/godotengine/godot/releases/download/${VERSION}/${name}"
            out="$WORKDIR/$name"
            if download "$url" "$out"; then
              EDITOR_ARCHIVE="$out"
              break
            fi
          done

          if [ -z "$EDITOR_ARCHIVE" ]; then
            echo "Failed to download Godot editor for platform: ${{ matrix.platform }}"
            exit 1
          fi

          # Extract editor
          case "$EDITOR_ARCHIVE" in
            *.zip) unzip -q "$EDITOR_ARCHIVE" -d "$WORKDIR" ;;
            *.tar.xz) tar -xJf "$EDITOR_ARCHIVE" -C "$WORKDIR" ;;
            *) echo "Unknown archive type: $EDITOR_ARCHIVE"; exit 1 ;;
          esac

          # Locate Godot binary
          if [ "${{ matrix.platform }}" = "Mac" ]; then
            GODOT_BIN=$(find "$WORKDIR" -type f -path "*/Godot.app/Contents/MacOS/Godot" -print -quit)
          else
            GODOT_BIN=$(find "$WORKDIR" -type f -executable -name "Godot_v${VERSION}_linux.x86_64" -print -quit || true)
            # fallback: pick any executable named Godot if exact name doesn't match
            if [ -z "$GODOT_BIN" ]; then
              GODOT_BIN=$(find "$WORKDIR" -type f -executable -name "Godot*" -print -quit || true)
            fi
          fi

          if [ -z "$GODOT_BIN" ]; then
            echo "Could not find Godot binary after extraction."
            ls -la "$WORKDIR"
            exit 1
          fi

          chmod +x "$GODOT_BIN"
          echo "GODOT_BIN=$GODOT_BIN" >> $GITHUB_ENV

          # Download export templates (.tpz)
          TPL_NAME="Godot_v${VERSION}_export_templates.tpz"
          TPL_URL="https://github.com/godotengine/godot/releases/download/${VERSION}/${TPL_NAME}"
          TPL_OUT="$WORKDIR/$TPL_NAME"
          if ! download "$TPL_URL" "$TPL_OUT"; then
            echo "Failed to download export templates: $TPL_URL"; exit 1
          fi

          # Extract export templates to Godot's expected folder
          VER_DIR=${VERSION//-/.}  # 4.5-stable -> 4.5.stable
          EXPORT_DIR="$HOME/.local/share/godot/export_templates/$VER_DIR"
          mkdir -p "$EXPORT_DIR"
          unzip -q -j "$TPL_OUT" -d "$EXPORT_DIR"  # flatten so .exe/.zip files are directly inside

      - name: Verify Godot
        run: |
          echo "Using Godot binary: $GODOT_BIN"
          "$GODOT_BIN" --version || true

      - name: Create builds folder
        run: mkdir -p builds

      - name: Export Godot Build
        run: |
          set -eux
          case "${{ matrix.platform }}" in
            Windows)
              "$GODOT_BIN" --headless --export-release "Windows Desktop" builds/game.exe
              ;;
            Mac)
              "$GODOT_BIN" --headless --export-release "macOS" builds/game.app
              ;;
            *)
              echo "Unknown platform: ${ matrix.platform }"
              exit 1
              ;;
          esac

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: builds/
